{% extends 'base.html' %}

{% block title %}{{ titulo }} - ERP{% endblock %}

{% block content %}
<div class="erp-form-container">
    <!-- Header ejecutivo -->
    <div class="erp-form-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
            </div>
            <div class="header-text">
                <h1>{{ titulo }}</h1>
                <p>{% if form.instance.pk %}Actualiza la información del producto{% else %}Registra un nuevo producto en el inventario{% endif %}</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="{% url 'products:productos' %}" class="erp-btn erp-btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al listado
            </a>
        </div>
    </div>

    <!-- Formulario principal -->
    <div class="erp-form-content">
        <form method="post" enctype="multipart/form-data" class="erp-form">
            {% csrf_token %}
            
            <!-- Alertas de error -->
            {% if form.errors %}
                <div class="erp-alert erp-alert-error">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <h4>Errores en el formulario</h4>
                        <p>Por favor, revisa y corrige los campos marcados en rojo.</p>
                    </div>
                </div>
            {% endif %}
            {{ form.non_field_errors }}

            <!-- Grid de campos -->
            <div class="form-grid">
                <!-- Información básica -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
                        <p>Datos principales del producto</p>
                    </div>
                    
                    {% for field in form.visible_fields %}
                        {% if field.name == 'nombre' or field.name == 'descripcion' or field.name == 'categoria' %}
                            <div class="erp-field-group {% if field.errors %}has-error{% endif %}">
                                <label class="erp-label" for="{{ field.id_for_label }}">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="required">*</span>{% endif %}
                                </label>
                                <div class="erp-input-wrapper">
                                    {{ field }}
                                    {% if field.name == 'descripcion' %}
                                        <div class="input-icon">
                                            <i class="fas fa-align-left"></i>
                                        </div>
                                    {% elif field.name == 'nombre' %}
                                        <div class="input-icon">
                                            <i class="fas fa-tag"></i>
                                        </div>
                                    {% elif field.name == 'categoria' %}
                                        <div class="input-icon">
                                            <i class="fas fa-folder"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                {% if field.name == 'categoria' %}
                                    <small class="field-help">Selecciona una categoría estándar. Si no encuentras la tuya, elige "Otros".</small>
                                {% endif %}
                                {% if field.help_text %}
                                    <small class="field-help">{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="field-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Información comercial -->
                <div class="form-section">
                    <div class="section-header">
                        <h3><i class="fas fa-dollar-sign"></i> Información Comercial</h3>
                        <p>Precios y stock del producto</p>
                    </div>
                    
                    {% for field in form.visible_fields %}
                        {% if field.name == 'precio' or field.name == 'stock' %}
                            <div class="erp-field-group {% if field.errors %}has-error{% endif %}">
                                <label class="erp-label" for="{{ field.id_for_label }}">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="required">*</span>{% endif %}
                                </label>
                                <div class="erp-input-wrapper">
                                    {{ field }}
                                    <div class="input-icon">
                                        {% if field.name == 'precio' %}
                                            <i class="fas fa-dollar-sign"></i>
                                        {% elif field.name == 'stock' %}
                                            <i class="fas fa-boxes"></i>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if field.help_text %}
                                    <small class="field-help">{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="field-error">
                                        <i class="fas fa-exclamation-circle"></i>
                                        {{ error }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    <!-- Estado activo -->
                    <div class="erp-field-group">
                        <label class="erp-label">Estado del producto</label>
                        <div class="toggle-wrapper">
                            <label class="erp-toggle">
                                <input type="checkbox" id="id_activo" name="activo" {% if form.instance.activo %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">
                                    <span class="toggle-text-active">Activo</span>
                                    <span class="toggle-text-inactive">Inactivo</span>
                                </span>
                            </label>
                        </div>
                        <small class="field-help">Los productos activos aparecen en el catálogo</small>
                    </div>
                </div>
            </div>

            <!-- Sección de imágenes -->
            <div class="form-section full-width">
                <div class="section-header">
                    <h3><i class="fas fa-images"></i> Galería de Imágenes</h3>
                    <p>Gestiona las imágenes del producto (máximo 5 imágenes)</p>
                </div>

                <!-- Upload de nuevas imágenes -->
                <div class="erp-field-group">
                    <label class="erp-label" for="id_imagen">Agregar imágenes</label>
                    {% if imagenes and imagenes|length >= 5 %}
                        <div class="upload-disabled">
                            <i class="fas fa-info-circle"></i>
                            Has alcanzado el límite máximo de 5 imágenes. Elimina alguna para agregar nuevas.
                        </div>
                    {% else %}
                        <div class="file-upload-area" id="upload-area">
                            <input type="file" name="imagen" id="id_imagen" multiple accept="image/*">
                            <div class="upload-content" id="upload-content">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <h4>Arrastra imágenes aquí o haz clic para seleccionar</h4>
                                <p>Máximo 5 imágenes • JPG, PNG, GIF • Máx. 5MB cada una</p>
                            </div>
                        </div>
                        
                        <!-- Vista previa de imágenes seleccionadas -->
                        <div id="preview-container" class="preview-container" style="display: none;">
                            <h5>Imágenes seleccionadas:</h5>
                            <div id="preview-grid" class="preview-grid"></div>
                            <button type="button" id="clear-selection" class="btn-clear">
                                <i class="fas fa-times"></i> Limpiar selección
                            </button>
                        </div>
                    {% endif %}
                    <small class="field-help">Puedes seleccionar varias imágenes a la vez. La primera imagen será la principal por defecto.</small>
                </div>

                <!-- Imágenes actuales - FORMULARIOS FUERA DEL PRINCIPAL -->
                {% if imagenes %}
                <div class="imagenes-actuales">
                    <label class="erp-label">Imágenes actuales:</label>
                    <div class="imagenes-lista">
                        {% for img in imagenes %}
                            <div class="img-thumb">
                                <img src="{{ img.imagen.url }}" alt="Imagen producto" />
                                <button type="button" class="btn-eliminar-img" title="Eliminar imagen" data-imagen-id="{{ img.id }}" data-action="eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button type="button" class="btn-principal-img" title="Marcar como principal" data-imagen-id="{{ img.id }}" data-action="principal" {% if img.principal %}disabled style="opacity: 0.5;"{% endif %}>
                                    {% if img.principal %}
                                        <i class="fas fa-star"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Botones de acción -->
            <div class="form-actions">
                <button type="submit" class="erp-btn erp-btn-primary erp-btn-large">
                    <i class="fas fa-save"></i>
                    {% if form.instance.pk %}Actualizar Producto{% else %}Crear Producto{% endif %}
                </button>
                <a href="{% url 'products:productos' %}" class="erp-btn erp-btn-secondary erp-btn-large">
                    <i class="fas fa-times"></i>
                    Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Formularios ocultos para acciones de imágenes (FUERA del formulario principal) -->
{% if imagenes %}
    {% for img in imagenes %}
        <form id="form-eliminar-{{ img.id }}" method="post" action="{% url 'products:eliminar_imagen_producto' img.id %}" style="display: none;">
            {% csrf_token %}
        </form>
        <form id="form-principal-{{ img.id }}" method="post" action="{% url 'products:marcar_principal_imagen_producto' img.id %}" style="display: none;">
            {% csrf_token %}
        </form>
    {% endfor %}
{% endif %}

<style>
.erp-form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1.5rem;
}

/* Header ejecutivo */
.erp-form-header {
    background: var(--panel-header-bg);
    color: var(--panel-title-color);
    padding: 2rem;
    border-radius: var(--erp-radius);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--panel-header-border);
}

.erp-form-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    z-index: 2;
}

.header-icon {
    width: 60px;
    height: 60px;
    background: var(--btn-main-bg);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: var(--btn-main-color);
}

.header-text h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.header-text p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.header-actions {
    z-index: 2;
}

.erp-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
}

.erp-btn-primary {
    background: var(--btn-main-bg);
    color: var(--btn-main-color);
}

.erp-btn-primary:hover {
    background: var(--btn-main-hover-bg);
    transform: translateY(-2px);
}

.erp-btn-secondary {
    background: var(--btn-main-bg);
    color: var(--btn-main-color);
    border: 1px solid var(--btn-main-bg);
}

.erp-btn-secondary:hover {
    background: var(--btn-main-hover-bg);
    border-color: var(--btn-main-hover-bg);
}

.erp-btn-large {
    padding: 1rem 2rem;
    font-size: 1.1rem;
}

/* Contenido del formulario */
.erp-form-content {
    background: var(--erp-surface);
    border: 1px solid var(--erp-border);
    border-radius: var(--erp-radius);
    box-shadow: var(--erp-shadow);
    overflow: hidden;
}

.erp-form {
    padding: 2rem;
}

/* Alertas */
.erp-alert {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.erp-alert-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
}

.alert-icon {
    font-size: 1.2rem;
    margin-top: 0.1rem;
}

.alert-content h4 {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

/* Grid de formulario */
.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.form-section {
    background: var(--erp-gray-50);
    border: 1px solid var(--erp-border);
    border-radius: 8px;
    padding: 1.5rem;
}

.form-section.full-width {
    grid-column: 1 / -1;
    background: var(--erp-surface);
}

.section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--erp-border);
}

.section-header h3 {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--erp-text);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-header p {
    color: var(--erp-gray-500);
    font-size: 0.9rem;
}

/* Campos del formulario */
.erp-field-group {
    margin-bottom: 1.5rem;
}

.erp-field-group.has-error .erp-input-wrapper input,
.erp-field-group.has-error .erp-input-wrapper textarea,
.erp-field-group.has-error .erp-input-wrapper select {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.erp-label {
    display: block;
    font-weight: 600;
    color: var(--erp-text);
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.required {
    color: #ef4444;
    margin-left: 0.25rem;
}

.erp-input-wrapper {
    position: relative;
}

.erp-input-wrapper input,
.erp-input-wrapper textarea,
.erp-input-wrapper select {
    width: 100%;
    padding: 0.75rem 1rem;
    padding-right: 2.5rem;
    border: 1px solid var(--erp-border);
    border-radius: 6px;
    font-size: 1rem;
    background: var(--erp-surface);
    color: var(--erp-text);
    transition: all 0.2s;
}

.erp-input-wrapper input:focus,
.erp-input-wrapper textarea:focus,
.erp-input-wrapper select:focus {
    border-color: var(--btn-main-bg);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    outline: none;
}

.erp-input-wrapper textarea {
    min-height: 100px;
    resize: vertical;
    padding-right: 1rem;
}

.input-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--erp-gray-400);
    pointer-events: none;
}

.field-help {
    display: block;
    color: var(--erp-gray-500);
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.field-error {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

/* Toggle switch */
.toggle-wrapper {
    margin-bottom: 0.5rem;
}

.erp-toggle {
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
}

.erp-toggle input {
    display: none;
}

.toggle-slider {
    position: relative;
    width: 60px;
    height: 32px;
    background: #e2e8f0;
    border-radius: 16px;
    transition: background 0.3s;
}

.toggle-slider::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.erp-toggle input:checked + .toggle-slider {
    background: var(--btn-main-bg);
}

.erp-toggle input:checked + .toggle-slider::before {
    transform: translateX(28px);
}

.toggle-label {
    font-weight: 500;
}

.toggle-text-active,
.toggle-text-inactive {
    display: none;
}

.erp-toggle input:checked ~ .toggle-label .toggle-text-active {
    display: inline;
}

.erp-toggle input:not(:checked) ~ .toggle-label .toggle-text-inactive {
    display: inline;
}

/* Upload de archivos */
.file-upload-area {
    border: 2px dashed var(--erp-border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s;
    position: relative;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: var(--btn-main-bg);
    background: var(--erp-gray-50);
}

.upload-content i {
    font-size: 3rem;
    color: var(--erp-gray-400);
    margin-bottom: 1rem;
}

.upload-content h4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--erp-text);
    margin-bottom: 0.5rem;
}

.upload-content p {
    color: var(--erp-gray-500);
    font-size: 0.9rem;
}

.file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-disabled {
    background: #fef3c7;
    color: #92400e;
    padding: 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

/* Galería de imágenes */
.current-images h4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--erp-text);
    margin-bottom: 1rem;
}

.images-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}

.image-card {
    background: var(--erp-surface);
    border: 1px solid var(--erp-border);
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s;
}

.image-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.image-preview {
    position: relative;
    width: 100%;
    height: 120px;
    overflow: hidden;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.principal-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    background: #fbbf24;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.image-actions {
    padding: 0.75rem;
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.action-form {
    margin: 0;
}

.action-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.action-star {
    background: #fbbf24;
    color: white;
}

.action-star:hover:not(:disabled) {
    background: #f59e0b;
}

.action-star:disabled {
    background: #fde68a;
    color: #92400e;
    cursor: not-allowed;
}

.action-delete {
    background: #ef4444;
    color: white;
}

.action-delete:hover {
    background: #dc2626;
}

/* Botones de acción */
.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 2rem;
    border-top: 1px solid var(--erp-border);
}

/* Responsive */
@media (max-width: 768px) {
    .erp-form-container {
        padding: 1rem;
    }
    
    .erp-form-header {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }
    
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }
    
    .header-text h1 {
        font-size: 1.5rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .erp-form {
        padding: 1rem;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .erp-btn-large {
        width: 100%;
        justify-content: center;
    }
    
    .images-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}

@media (max-width: 480px) {
    .header-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
    
    .header-text h1 {
        font-size: 1.3rem;
    }
    
    .header-text p {
        font-size: 1rem;
    }
    
    .section-header h3 {
        font-size: 1.1rem;
    }
    
    .images-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
    
    .image-preview {
        height: 100px;
    }
}

/* Dark Mode */
body.dark-mode .erp-form-header {
    background: var(--panel-header-bg);
    color: var(--panel-title-color);
    border-color: var(--panel-header-border);
}

body.dark-mode .erp-form-content,
body.dark-mode .form-section {
    background: #1e293b;
    border-color: #334155;
}

body.dark-mode .form-section {
    background: #334155;
}

body.dark-mode .form-section.full-width {
    background: #1e293b;
}

body.dark-mode .section-header {
    border-color: #475569;
}

body.dark-mode .erp-input-wrapper input,
body.dark-mode .erp-input-wrapper textarea,
body.dark-mode .erp-input-wrapper select {
    background: #334155;
    border-color: #475569;
    color: #f1f5f9;
}

body.dark-mode .file-upload-area {
    border-color: #475569;
}

body.dark-mode .file-upload-area:hover {
    background: #334155;
}

body.dark-mode .image-card {
    background: #334155;
    border-color: #475569;
}

body.dark-mode .erp-alert-error {
    background: #7f1d1d;
    border-color: #991b1b;
    color: #fca5a5;
}

body.dark-mode .upload-disabled {
    background: #92400e;
    color: #fde68a;
}

/* Estilos para upload moderno */
.file-upload-area {
    border: 2px dashed var(--erp-border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    background: var(--erp-gray-50);
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.file-upload-area:hover {
    border-color: var(--btn-main-bg);
    background: #f0f9ff;
}

.file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-content {
    pointer-events: none;
}

.upload-content i {
    font-size: 3rem;
    color: var(--btn-main-bg);
    margin-bottom: 1rem;
}

.upload-content h4 {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--erp-text);
    margin-bottom: 0.5rem;
}

.upload-content p {
    color: var(--erp-gray-500);
    font-size: 0.9rem;
}

.upload-disabled {
    background: #fef3c7;
    color: #92400e;
    padding: 1rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

/* Vista previa de imágenes seleccionadas */
.preview-container {
    margin-top: 1rem;
    padding: 1rem;
    border: 1px solid var(--erp-border);
    border-radius: 8px;
    background: var(--erp-gray-50);
}

.preview-container h5 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--erp-text);
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.preview-item {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--erp-border);
    background: #fff;
}

.preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.preview-item .remove-preview {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.7rem;
    transition: background 0.2s;
}

.preview-item .remove-preview:hover {
    background: #dc2626;
}

.preview-item .file-name {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 0.25rem;
    font-size: 0.7rem;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.btn-clear {
    background: #6b7280;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.2s;
}

.btn-clear:hover {
    background: #4b5563;
}

.file-upload-area.has-files {
    border-color: var(--btn-main-bg);
    background: #f0f9ff;
}

.file-upload-area.has-files .upload-content {
    opacity: 0.7;
}

.file-upload-area.dragover {
    border-color: var(--btn-main-bg);
    background: #f0f9ff;
    transform: scale(1.02);
}

/* Estilos originales para imágenes que funcionan */
.imagenes-actuales {
    margin-bottom: 1.2rem;
}
.imagenes-lista {
    display: flex;
    gap: 1.2rem;
    flex-wrap: wrap;
}
.img-thumb {
    position: relative;
    width: 70px;
    height: 70px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(37,99,235,0.10);
    background: #f8fafc;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
}
.img-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}
.btn-eliminar-img {
    position: absolute;
    top: 2px;
    right: 2px;
    background: #b91c1c;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    transition: background 0.2s;
    z-index: 2;
    padding: 0;
    text-decoration: none;
}
.btn-eliminar-img:hover {
    background: #7f1d1d;
    color: #fff;
}
.btn-principal-img {
    position: absolute;
    top: 2px;
    left: 2px;
    background: #fbbf24;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
    z-index: 2;
    padding: 0;
    text-decoration: none;
}
.btn-principal-img:hover {
    background: #f59e0b;
    color: #fff;
}

/* Dark mode para imágenes originales */
body.dark-mode .img-thumb {
    background: #334155;
    box-shadow: 0 2px 8px rgba(15,23,42,0.18);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Solo indicador de carga en el botón - SIN INTERFERIR CON EL FORMULARIO
    const form = document.querySelector('.erp-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) {
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                
                // Re-habilitar después de un tiempo por si hay errores
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }, 8000);
            }
        });
    }
    
    // Auto-resize para textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Mejorar la experiencia del toggle
    const toggle = document.querySelector('.erp-toggle input');
    if (toggle) {
        toggle.addEventListener('change', function() {
            const label = this.closest('.erp-toggle').querySelector('.toggle-label');
            if (label) {
                label.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    label.style.transform = 'scale(1)';
                }, 150);
            }
        });
    }
});

// JavaScript para manejar las acciones de imágenes y vista previa
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_imagen');
    const uploadArea = document.getElementById('upload-area');
    const previewContainer = document.getElementById('preview-container');
    const previewGrid = document.getElementById('preview-grid');
    const clearButton = document.getElementById('clear-selection');
    
    let selectedFiles = [];

    // Manejar selección de archivos
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // Limpiar selección
        if (clearButton) {
            clearButton.addEventListener('click', function() {
                clearSelection();
            });
        }
    }

    function handleFiles(files) {
        selectedFiles = Array.from(files);
        updateFileInput();
        showPreview();
    }

    function updateFileInput() {
        // Crear un nuevo DataTransfer para actualizar el input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
    }

    function showPreview() {
        if (selectedFiles.length === 0) {
            previewContainer.style.display = 'none';
            uploadArea.classList.remove('has-files');
            return;
        }

        previewContainer.style.display = 'block';
        uploadArea.classList.add('has-files');
        previewGrid.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';

            const img = document.createElement('img');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-preview';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = function() {
                removeFile(index);
            };

            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = file.name;

            previewItem.appendChild(img);
            previewItem.appendChild(removeBtn);
            previewItem.appendChild(fileName);
            previewGrid.appendChild(previewItem);
        });
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileInput();
        showPreview();
    }

    function clearSelection() {
        selectedFiles = [];
        fileInput.value = '';
        showPreview();
    }

    // Event listeners para acciones de imágenes existentes
    // Botones de eliminar imagen
    document.querySelectorAll('[data-action="eliminar"]').forEach(button => {
        button.addEventListener('click', function() {
            const imagenId = this.getAttribute('data-imagen-id');
            if (confirm('¿Estás seguro de que quieres eliminar esta imagen?')) {
                document.getElementById('form-eliminar-' + imagenId).submit();
            }
        });
    });

    // Botones de marcar como principal
    document.querySelectorAll('[data-action="principal"]').forEach(button => {
        button.addEventListener('click', function() {
            const imagenId = this.getAttribute('data-imagen-id');
            document.getElementById('form-principal-' + imagenId).submit();
        });
    });
});
</script>
{% endblock %} 