{% extends 'base.html' %}
{% load static %}

{% block title %}Reserva #{{ reserva.id }} - TeoManager{% endblock %}

{% block extra_css %}
<style>
    /* === VARIABLES PROFESIONALES === */
    :root {
        --primary-blue: #3b82f6;
        --primary-blue-dark: #2563eb;
        --amazon-orange: #0066ff;
        --amazon-blue: #232f3e;
        --amazon-light-blue: #37475a;
        --amazon-gray: #eaeded;
        --amazon-text: #0f1111;
        --amazon-secondary: #565959;
        --success-green: #007600;
        --warning-orange: #b12704;
        --border-color: #d5d9d9;
        --hover-bg: #f7fafa;
        --spacing-unit: 1rem;
    }

    /* === LAYOUT PROFESIONAL === */
    body {
        font-family: "Amazon Ember", Arial, sans-serif;
        background-color: white;
        color: var(--amazon-text);
        line-height: 1.4;
    }

    .reserva-detail-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 0 1rem;
        background: white;
        margin-bottom: 3rem;
    }

    /* === HEADER PROFESIONAL === */
    .page-header {
        background: white;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 1rem;
    }

    .breadcrumb {
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: var(--amazon-secondary);
    }

    .breadcrumb a {
        color: #007185;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        color: #c7511f;
        text-decoration: underline;
    }

    .breadcrumb i {
        margin: 0 0.5rem;
        font-size: 0.75rem;
    }

    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title h1 {
        font-size: 1.5rem;
        font-weight: 400;
        margin: 0;
        color: var(--amazon-text);
    }

    .reserva-actions {
        display: flex;
        gap: 0.75rem;
    }

    .btn-action {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: white;
        color: var(--amazon-text);
        text-decoration: none;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-action:hover {
        background: var(--hover-bg);
        border-color: #999;
        color: var(--amazon-text);
        text-decoration: none;
    }

    .btn-action-primary {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
    }

    .btn-action-primary:hover {
        background: var(--primary-blue-dark);
        border-color: var(--primary-blue-dark);
        color: white;
    }

    .btn-action-danger {
        background: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    .btn-action-danger:hover {
        background: #c82333;
        border-color: #bd2130;
        color: white;
    }

    /* === SECCIÓN DE ESTADO === */
    .reserva-status-section {
        background: var(--amazon-gray);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .reserva-number {
        font-size: 0.875rem;
        color: var(--amazon-secondary);
        font-weight: 500;
    }

    .reserva-date {
        font-size: 0.875rem;
        color: var(--amazon-secondary);
    }

    .status-message {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
        font-weight: 500;
    }

    .status-message.pendiente {
        color: #664d03;
    }

    .status-message.confirmada {
        color: var(--success-green);
    }

    .status-message.en_proceso {
        color: var(--warning-orange);
    }

    .status-message.completada {
        color: var(--success-green);
    }

    .status-message.cancelada {
        color: var(--warning-orange);
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .status-pendiente {
        background: #fff3cd;
        color: #664d03;
        border: 1px solid #ffecb3;
    }

    .status-confirmada {
        background: #d1e7dd;
        color: #0a3622;
        border: 1px solid #a3cfbb;
    }

    .status-en_proceso {
        background: #ffe4cc;
        color: #994c00;
        border: 1px solid #ffcc99;
    }

    .status-completada {
        background: #d1e7dd;
        color: #0a3622;
        border: 1px solid #a3cfbb;
    }

    .status-cancelada {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f1aeb5;
    }

    /* === SECCIONES DE CONTENIDO === */
    .detail-section {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1rem;
        background: white;
    }

    .section-header {
        background: var(--amazon-gray);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        font-size: 1rem;
        font-weight: 500;
        color: var(--amazon-text);
    }

    .section-content {
        padding: 1rem;
    }

    /* === INFORMACIÓN DEL SERVICIO === */
    .service-info {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .service-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .service-image-placeholder {
        width: 120px;
        height: 120px;
        background: var(--amazon-gray);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--amazon-secondary);
        font-size: 2rem;
        flex-shrink: 0;
    }

    .service-details {
        flex: 1;
        min-width: 0;
    }

    .service-name {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--amazon-text);
        margin-bottom: 0.5rem;
    }

    .service-name a {
        color: #007185;
        text-decoration: none;
    }

    .service-name a:hover {
        color: #c7511f;
        text-decoration: underline;
    }

    .service-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.875rem;
        color: var(--amazon-secondary);
    }

    .service-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .service-meta-item i {
        width: 16px;
        color: var(--amazon-secondary);
    }

    /* === INFORMACIÓN DE CONTACTO === */
    .contact-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .contact-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .contact-icon {
        width: 40px;
        height: 40px;
        background: var(--amazon-gray);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--amazon-secondary);
        flex-shrink: 0;
    }

    .contact-details {
        flex: 1;
        min-width: 0;
    }

    .contact-label {
        font-size: 0.75rem;
        color: var(--amazon-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .contact-value {
        font-size: 0.875rem;
        color: var(--amazon-text);
        font-weight: 500;
    }

    /* === INFORMACIÓN DE EMPRESA/CLIENTE === */
    .party-info {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .party-avatar {
        width: 60px;
        height: 60px;
        background: var(--primary-blue);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 600;
        flex-shrink: 0;
    }

    .party-details {
        flex: 1;
        min-width: 0;
    }

    .party-name {
        font-size: 1.125rem;
        font-weight: 500;
        color: var(--amazon-text);
        margin-bottom: 0.5rem;
    }

    .party-contact {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        font-size: 0.875rem;
        color: var(--amazon-secondary);
    }

    /* === RESUMEN DE PRECIO === */
    .price-summary {
        background: var(--amazon-gray);
        padding: 1rem;
        border-radius: 8px;
    }

    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        font-size: 0.875rem;
    }

    .price-row.total {
        border-top: 2px solid var(--border-color);
        margin-top: 0.5rem;
        padding-top: 1rem;
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--amazon-text);
    }

    .price-label {
        color: var(--amazon-secondary);
    }

    .price-value {
        font-weight: 500;
        color: var(--amazon-text);
    }

    .price-value.total {
        font-size: 1.5rem;
        color: var(--primary-blue);
    }

    /* === NOTAS === */
    .notes-content {
        font-size: 0.875rem;
        color: var(--amazon-text);
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .notes-empty {
        font-size: 0.875rem;
        color: var(--amazon-secondary);
        font-style: italic;
    }

    /* === ACCIONES DE EMPRESA === */
    .status-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .status-select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.875rem;
        background: white;
        color: var(--amazon-text);
        cursor: pointer;
    }

    .status-select:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .btn-update-status {
        padding: 0.5rem 1rem;
        border: 1px solid var(--primary-blue);
        border-radius: 4px;
        background: var(--primary-blue);
        color: white;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-update-status:hover {
        background: var(--primary-blue-dark);
        border-color: var(--primary-blue-dark);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .service-info {
            flex-direction: column;
        }

        .party-info {
            flex-direction: column;
        }

        .status-actions {
            flex-direction: column;
        }

        .status-select,
        .btn-update-status {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="reserva-detail-container">
    <!-- Header -->
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{% url 'home' %}"><i class="fas fa-home"></i> Inicio</a>
            <i class="fas fa-chevron-right"></i>
            <a href="{% url 'products:mis_reservas' %}">Mis Reservas</a>
            <i class="fas fa-chevron-right"></i>
            <span>Reserva #{{ reserva.id }}</span>
        </div>
        <div class="page-title">
            <h1>Reserva #{{ reserva.id }}</h1>
            <div class="reserva-actions">
                <a href="{% url 'products:mis_reservas' %}" class="btn-action">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    <!-- Estado de la Reserva -->
    <div class="reserva-status-section">
        <div class="status-header">
            <div>
                <div class="reserva-number">Reserva #{{ reserva.id }}</div>
                <div class="reserva-date">Creada el {{ reserva.fecha_creacion|date:"d M Y, H:i" }}</div>
            </div>
            <div class="status-message {{ reserva.estado }}">
                <span class="status-badge status-{{ reserva.estado }}">
                    {% if reserva.estado == 'pendiente' %}
                        <i class="fas fa-clock"></i>
                    {% elif reserva.estado == 'confirmada' %}
                        <i class="fas fa-check-circle"></i>
                    {% elif reserva.estado == 'en_proceso' %}
                        <i class="fas fa-spinner fa-spin"></i>
                    {% elif reserva.estado == 'completada' %}
                        <i class="fas fa-check-double"></i>
                    {% elif reserva.estado == 'cancelada' %}
                        <i class="fas fa-times-circle"></i>
                    {% endif %}
                    {{ reserva.get_estado_display }}
                </span>
            </div>
        </div>
    </div>

    <!-- Información del Servicio -->
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-concierge-bell"></i> Información del Servicio
        </div>
        <div class="section-content">
            <div class="service-info">
                {% if reserva.servicio.imagen_principal %}
                    <img src="{{ reserva.servicio.imagen_principal }}" alt="{{ reserva.servicio.nombre }}" class="service-image">
                {% else %}
                    <div class="service-image-placeholder">
                        <i class="fas fa-image"></i>
                    </div>
                {% endif %}
                <div class="service-details">
                    <div class="service-name">
                        <a href="{% url 'products:detalle_servicio' reserva.servicio.pk %}">{{ reserva.servicio.nombre }}</a>
                    </div>
                    <div class="service-meta">
                        <div class="service-meta-item">
                            <i class="fas fa-clock"></i>
                            <span>Duración: {{ reserva.servicio.duracion }}</span>
                        </div>
                        <div class="service-meta-item">
                            <i class="fas fa-tag"></i>
                            <span>Categoría: {{ reserva.servicio.categoria }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de la Reserva -->
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-calendar-alt"></i> Detalles de la Reserva
        </div>
        <div class="section-content">
            <div class="contact-info">
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="contact-details">
                        <div class="contact-label">Fecha y Hora Programada</div>
                        <div class="contact-value">{{ reserva.fecha_reserva|date:"d M Y, H:i" }}</div>
                    </div>
                </div>
                {% if reserva.telefono_contacto %}
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="contact-details">
                        <div class="contact-label">Teléfono de Contacto</div>
                        <div class="contact-value">{{ reserva.telefono_contacto }}</div>
                    </div>
                </div>
                {% endif %}
                {% if reserva.direccion_servicio %}
                <div class="contact-item">
                    <div class="contact-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="contact-details">
                        <div class="contact-label">Dirección del Servicio</div>
                        <div class="contact-value">{{ reserva.direccion_servicio }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Información de la Empresa/Cliente -->
    <div class="detail-section">
        <div class="section-header">
            {% if es_cliente %}
                <i class="fas fa-store"></i> Información de la Empresa
            {% else %}
                <i class="fas fa-user"></i> Información del Cliente
            {% endif %}
        </div>
        <div class="section-content">
            <div class="party-info">
                <div class="party-avatar">
                    {% if es_cliente %}
                        {{ reserva.empresa.username|first|upper }}
                    {% else %}
                        {{ reserva.usuario.username|first|upper }}
                    {% endif %}
                </div>
                <div class="party-details">
                    <div class="party-name">
                        {% if es_cliente %}
                            {{ reserva.empresa_info }}
                        {% else %}
                            {{ reserva.usuario.username }}
                        {% endif %}
                    </div>
                    <div class="party-contact">
                        {% if es_cliente %}
                            <div><i class="fas fa-envelope"></i> {{ reserva.empresa.email }}</div>
                        {% else %}
                            <div><i class="fas fa-envelope"></i> {{ reserva.usuario.email }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notas -->
    {% if reserva.notas %}
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-sticky-note"></i> Notas Adicionales
        </div>
        <div class="section-content">
            <div class="notes-content">{{ reserva.notas }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Resumen de Precio -->
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-receipt"></i> Resumen de Precio
        </div>
        <div class="section-content">
            <div class="price-summary">
                <div class="price-row">
                    <span class="price-label">Precio del Servicio</span>
                    <span class="price-value">${{ reserva.servicio.precio|floatformat:2 }}</span>
                </div>
                <div class="price-row total">
                    <span class="price-label">Total</span>
                    <span class="price-value total">${{ reserva.precio_total|floatformat:2 }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones de Empresa -->
    {% if es_empresa and reserva.estado != 'cancelada' and reserva.estado != 'completada' %}
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-cog"></i> Gestionar Reserva
        </div>
        <div class="section-content">
            <div class="status-actions">
                <select id="estado-select" class="status-select">
                    <option value="pendiente" {% if reserva.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                    <option value="confirmada" {% if reserva.estado == 'confirmada' %}selected{% endif %}>Confirmada</option>
                    <option value="en_proceso" {% if reserva.estado == 'en_proceso' %}selected{% endif %}>En Proceso</option>
                    <option value="completada" {% if reserva.estado == 'completada' %}selected{% endif %}>Completada</option>
                </select>
                <button onclick="actualizarEstado()" class="btn-update-status">
                    <i class="fas fa-save"></i> Actualizar Estado
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Acciones de Cliente -->
    {% if es_cliente and reserva.puede_cancelarse %}
    <div class="detail-section">
        <div class="section-header">
            <i class="fas fa-exclamation-triangle"></i> Acciones
        </div>
        <div class="section-content">
            <button onclick="cancelarReserva()" class="btn-action btn-action-danger">
                <i class="fas fa-times"></i> Cancelar Reserva
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
function actualizarEstado() {
    const estado = document.getElementById('estado-select').value;
    const reservaId = {{ reserva.id }};
    
    fetch(`/products/reserva/${reservaId}/actualizar-estado/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `estado=${estado}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al actualizar el estado');
    });
}

function cancelarReserva() {
    if (!confirm('¿Estás seguro de que deseas cancelar esta reserva?')) {
        return;
    }
    
    const motivo = prompt('Motivo de la cancelación (opcional):');
    const reservaId = {{ reserva.id }};
    
    fetch(`/products/reserva/${reservaId}/cancelar/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `motivo=${encodeURIComponent(motivo || '')}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cancelar la reserva');
    });
}
</script>
{% endblock %}

